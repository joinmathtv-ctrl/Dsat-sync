<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Digital SAT Practice — Catalog</title>
<link rel="stylesheet" href="./assets/style.css">
<style>
  .hidden{display:none}
  .tabs{display:flex;gap:8px;margin:10px 0}
  .tab{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#f8f9fb;cursor:pointer}
  .tab.active{background:#e7f0ff;border-color:#c6d4ff}
  .tabview{display:none}
  .tabview.active{display:block}
  .grid{display:grid;gap:14px}
  .grid.grid-3{grid-template-columns:repeat(3,1fr)}
  .grid.grid-2{grid-template-columns:repeat(2,1fr)}
  .grid.list{grid-template-columns:1fr}
  .card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px}
  .item{display:flex;flex-direction:column}
  .item .thumb{height:120px;background:#f3f4f6;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .item .thumb img{width:100%;height:100%;object-fit:cover}
  .item .body{padding:10px 4px}
  .item .title{font-weight:700}
  .item .sub{color:#666;margin-top:4px}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .tag{font-size:12px;background:#f1f5f9;border-radius:999px;padding:4px 8px}
  .foot{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
  .btn{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  .seg{display:inline-flex;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
  .seg-btn{padding:8px 12px;border:0;background:#fff;cursor:pointer}
  .seg-btn.active{background:#111827;color:#fff}
  .badge{background:#eef2ff;color:#334155;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;margin-left:8px;font-size:12px}
  .muted{color:#6b7280}
  .row{display:flex}
  .grow{flex:1}
  .toprow{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .wrap{max-width:1080px;margin:0 auto;padding:14px}
  .ph {display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:12px;color:#6b7280}
  .ph.rw{background:#f1f5ff}
  .ph.math{background:#fff7ed}
</style>

</head>
<body>
<div class="wrap">

  <!-- 헤더 -->
  <header class="toprow">
    <div class="brand">
      <h1 class="title" style="margin:0; font-size:22px">Digital SAT Practice</h1>
      <span class="badge" id="ownedCount">Owned 0</span>
      <span class="badge" id="modeBadge">Mode: Full</span>
      <span class="badge hidden" id="roleBadge">ROLE</span>
    </div>
    <div class="controls">
      <button class="btn" id="gridBtn" aria-pressed="true">Grid</button>
      <button class="btn" id="listBtn" aria-pressed="false">List</button>
    </div>
  </header>

  <!-- 모드 선택 (Full / RW만 / Math만) -->
  <section class="card" style="margin:10px 0; padding:10px">
    <div id="modeSeg" class="seg" role="tablist" aria-label="Mode selection">
      <button class="seg-btn active" data-only="" role="tab" aria-selected="true">Full</button>
      <button class="seg-btn" data-only="rw" role="tab" aria-selected="false">RW only</button>
      <button class="seg-btn" data-only="math" role="tab" aria-selected="false">Math only</button>
    </div>
  </section>

  <!-- 검색/정렬/탭 (중복 제거: 단일 컨트롤만 유지) -->
  <section class="card" style="margin-bottom:14px">
    <div class="row" style="gap:10px; align-items:center">
      <input id="qInput" class="grow" type="text" placeholder="Search title or tag…"/>
      <select id="sortSelect">
        <option value="recent">Recent (filename desc)</option>
        <option value="title">Title A→Z</option>
        <option value="count">Question count desc</option>
        <option value="duration">Duration (desc)</option>
      </select>
      <select id="tierSelect" title="Tab">
        <option value="all">All</option>
        <option value="trial">Trial</option>
        <option value="paid">Paid</option>
        <option value="internal">Internal</option>
      </select>
      <button class="btn" id="clearBtn">Clear</button>
    </div>
  </section>

  <select id="topicSelect" title="Topic filter">
  <option value="">All topics</option>
  <!-- 동적으로 채움 -->
  </select>

  
  <!-- 탭 -->
  <nav class="tabs" role="tablist" aria-label="Set View">
    <button class="tab active" data-tab="catalog" role="tab" aria-selected="true">Catalog</button>
    <button class="tab" data-tab="owned" role="tab" aria-selected="false">My Sets</button>
    <button class="tab" data-tab="recents" role="tab" aria-selected="false">Recent</button>
    <button class="tab admin hidden" data-tab="admin" role="tab" aria-selected="false">Admin</button>
  </nav>

  <!-- 카탈로그 -->
  <section id="view-catalog" class="tabview active">
    <div id="catalogGrid" class="grid grid-3"></div>
    <div id="catalogEmpty" class="muted hidden" style="padding:24px">No sets matching your criteria.</div>
  </section>

  <!-- 내 세트 (권한 보유 묶음: Paid + Internal) -->
  <section id="view-owned" class="tabview">
    <div id="ownedGrid" class="grid grid-3"></div>
    <div id="ownedEmpty" class="muted hidden" style="padding:24px">You don't have any sets yet.</div>
  </section>

  <!-- 최근 (로컬 기록 기반) -->
  <section id="view-recents" class="tabview">
    <div id="recentsGrid" class="grid grid-2"></div>
    <div id="recentsEmpty" class="muted hidden" style="padding:24px">No recent records.</div>
  </section>

  <!-- 관리자(권한 부여) -->
  <section id="view-admin" class="tabview">
    <div class="card" style="padding:16px; max-width:720px">
      <h3 style="margin:0 0 12px">Temporary Access Grant</h3>
      <div class="grid" style="grid-template-columns:160px 1fr; gap:12px">
        <label>User Email</label><input id="grantUser" placeholder="email@domain.com"/>
        <label>Entitlement</label>
        <select id="grantEnt">
          <option value="PAID_SETS">PAID_SETS</option>
          <option value="INTERNAL_SETS">INTERNAL_SETS</option>
        </select>
        <label>Note</label><input id="grantNote" placeholder="(optional) reason"/>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:12px; gap:8px">
        <button class="btn" id="grantBtn">Grant</button>
      </div>
      <p class="muted" style="margin-top:8px">* Backend enforces admin-only via custom claims.</p>
    </div>
  </section>

  <!-- (개발자 모드) 직접 불러오기 → ?dev=1에서만 표시 -->
  <section id="devLoader" class="card hidden" style="padding:14px; margin-top:18px">
    <div style="font-weight:800; margin-bottom:10px">Developer: Load Directly</div>
    <div class="grid" style="grid-template-columns:140px 1fr; gap:12px; align-items:center">
      <label>JSON URL</label>
      <input id="jsonUrl" type="text" placeholder="https://.../questions.json"/>
      <label>Local File</label>
      <input id="jsonFile" class="uploader" type="file" accept=".json,application/json"/>
    </div>
    <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="startBtn">Start Test</button>
    </div>
    <p class="muted" style="margin-top:8px">※ This is only visible when ?dev=1 is appended to the URL.</p>
  </section>

</div>

<!-- 공통: auth helper (로컬 JWT 폴백용) -->
<script src="/_auth.js"></script>

<!-- Firebase SDK (compat 유지: 다른 페이지와 동일 버전) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>
/** **************
 * Catalog Logic (메타데이터 대응 완성본)
 * - 로그인 가드 (Firebase 우선, 로컬 JWT 폴백)
 * - /api/sets(메타: title/tags/count/thumb) 사용
 * - 단일 검색/정렬/티어선택 컨트롤
 * - 모드(RW/MATH) 필터, Grid/List, 탭, 최근/소유/관리자
 *****************/

// 0) 로그인 가드 + 토큰 획득
async function getIdTokenOrJwt() {
  try {
    if (window.firebase?.auth) {
      const u = firebase.auth().currentUser || null;
      if (!u) throw new Error('no-firebase-user');
      return await u.getIdToken(/* forceRefresh */ true);
    }
  } catch (e) { /* fallback below */ }
  // fallback: _auth.js 의 로컬 JWT
  const jwt = localStorage.getItem('jwt') || '';
  if (!jwt) {
    location.href = '/login.html';
    throw new Error('no-token');
  }
  return jwt;
}

// 1) 헬퍼들
function $(sel){ return document.querySelector(sel); }
function el(tag, attrs={}, html=''){ const d=document.createElement(tag); Object.assign(d, attrs); if(html) d.innerHTML=html; return d; }
function show(sel, on){ const n=$(sel); if(!n) return; n.classList[on?'remove':'add']('hidden'); }

// 2) 상태
let VIEW = 'catalog'; // catalog | owned | recents | admin
let ONLY = '';        // '' | 'rw' | 'math'
let LAYOUT = 'grid';  // grid | list
let SETS = { trial:[], paid:[], internal:[] }; // 서버 메타 원본
let ROLE = 'student';
let ENTS = [];

const qInput = $('#qInput');
const sortSelect = $('#sortSelect');
const tierSelect = $('#tierSelect');
const topicSelect = $('#topicSelect'); // ← 새 토픽 필터


// 3) 탭/레이아웃/모드/컨트롤 이벤트
function bindUI() {
  // 탭
  document.querySelectorAll('.tab').forEach(b=>{
    b.onclick = ()=> {
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('.tabview').forEach(x=>x.classList.remove('active'));
      VIEW = b.dataset.tab;
      $('#view-'+VIEW).classList.add('active');
      render();
    };
  });

  // 레이아웃
  $('#gridBtn').onclick = ()=> { LAYOUT='grid'; $('#gridBtn').ariaPressed='true'; $('#listBtn').ariaPressed='false'; render(); };
  $('#listBtn').onclick = ()=> { LAYOUT='list'; $('#gridBtn').ariaPressed='false'; $('#listBtn').ariaPressed='true'; render(); };

  // 모드
  document.querySelectorAll('#modeSeg .seg-btn').forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll('#modeSeg .seg-btn').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      ONLY = btn.dataset.only || '';
      $('#modeBadge').textContent = 'Mode: ' + (ONLY===''?'Full':ONLY.toUpperCase());
      render();
    };
  });

  // 컨트롤
  qInput.oninput = ()=> render();
  sortSelect.onchange = ()=> render();
  tierSelect.onchange = ()=> render();
  $('#clearBtn').onclick = ()=> { qInput.value=''; tierSelect.value='all'; render(); };
  topicSelect.onchange = ()=> render();


  // 개발자 모드
  const dev = new URLSearchParams(location.search).get('dev')==='1';
  show('#devLoader', dev);
}

// 4) API 호출
async function apiGet(url){
  const token = await getIdTokenOrJwt();
  const r = await fetch(url, { headers: { Authorization: 'Bearer '+token }});
  if(r.status===401) { location.href='/login.html'; return null; }
  return r.ok ? r.json() : null;
}
async function apiPost(url, body){
  const token = await getIdTokenOrJwt();
  const r = await fetch(url, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token },
    body: JSON.stringify(body||{})
  });
  if(!r.ok){
    const t = await r.text().catch(()=>String(r.status));
    throw new Error(t || ('HTTP '+r.status));
  }
  return r.json();
}

// 5) 메타 정규화 (서버가 metadata를 주지만 방어적으로 처리)
function normalizeFromServerItem(item){
  const type = item.type || 'trial';
  const key = item.key;
  const md = item.metadata || {};
  const title = String(md.title || key.replace(/\.json$/,'') || 'Untitled');
  const tags = Array.isArray(md.tags) ? md.tags.slice() : [];
  const count = Number(md.count || 0);
  const thumb = (typeof md.thumb === 'string' && md.thumb.length>0) ? md.thumb : null;

  const topics = Array.isArray(md.topics) ? md.topics.slice() : [];
  const level = (md.level || '').toString();
  const duration = Number(md.duration || 0);
  const subject = (md.subject || '').toLowerCase(); // 'rw'|'math'|''

  // 보정(구버전 안전장치)
  const low = (title + ' ' + key).toLowerCase();
  if (!tags.includes('math') && (low.includes('math'))) tags.push('math');
  if (!tags.includes('rw') && (low.includes('rw') || low.includes('read'))) tags.push('rw');
  if (type!=='trial' && !tags.includes(type)) tags.push(type);

  return { type, key, metadata:{ title, tags, count, thumb, topics, level, duration, subject } };
}

function populateTopics(){
  const allItems = [
    ...(SETS.trial||[]).map(normalizeFromServerItem),
    ...(SETS.paid||[]).map(normalizeFromServerItem),
    ...(SETS.internal||[]).map(normalizeFromServerItem),
  ];
  const setTopics = new Set();
  allItems.forEach(it => (it.metadata.topics||[]).forEach(t => t && setTopics.add(t)));
  const arr = Array.from(setTopics).sort((a,b)=>a.localeCompare(b));
  topicSelect.innerHTML = `<option value="">All topics</option>` + arr.map(t=>`<option value="${t}">${t}</option>`).join('');
}

function flattenCatalogByView(){
  if (VIEW==='catalog'){
    return [
      ...(SETS.trial||[]).map(normalizeFromServerItem),
      ...(SETS.paid||[]).map(normalizeFromServerItem),
      ...(SETS.internal||[]).map(normalizeFromServerItem),
    ];
  } else if (VIEW==='owned'){
    const out=[];
    if (ENTS.includes('PAID_SETS')) out.push(...(SETS.paid||[]).map(normalizeFromServerItem));
    if (ENTS.includes('INTERNAL_SETS')) out.push(...(SETS.internal||[]).map(normalizeFromServerItem));
    return out;
  } else if (VIEW==='recents'){
    try{
      const raw = localStorage.getItem('dsat_attempts_v1') || '[]';
      const arr = JSON.parse(raw);
      const uniq = arr.slice().sort((a,b)=>(b.updatedAt||b.ts||0)-(a.updatedAt||a.ts||0)).slice(0,10);
      return uniq.map(a=>{
        const title = a.title || a.baseId || 'Untitled';
        const tags = [a.kind||'base'];
        return { type:'recent', key:(a.baseId||'set'), metadata:{ title, tags, count:0, thumb:null } };
      });
    }catch{ return []; }
  }
  return [];
}

// 6) 필터·정렬·렌더
function applyFilters(list){
  // 티어
  const tier = tierSelect.value; // all|trial|paid|internal
  let out = list.filter(it => (tier==='all' ? true : it.type===tier));

  // 모드(RW/Math)
  if (ONLY){
    out = out.filter(it => {
      const subj = (it.metadata.subject||'').toLowerCase();
      if (subj) return subj === ONLY;
      return (it.metadata.tags||[]).includes(ONLY);
    });
  }

  // Topic
  const topic = topicSelect.value;
  if (topic){
    out = out.filter(it => (it.metadata.topics||[]).includes(topic));
  }

  // 검색
  const q = (qInput.value||'').trim().toLowerCase();
  if (q){
    out = out.filter(it=>{
      const {title='', tags=[], topics=[]} = it.metadata || {};
      const hay = [title.toLowerCase(), ...tags.map(t=>String(t).toLowerCase()), ...topics.map(t=>String(t).toLowerCase())];
      return hay.some(x=> x.includes(q));
    });
  }

  // 정렬
  const by = sortSelect.value;
  out.sort((a,b)=>{
    if (by==='title')    return a.metadata.title.localeCompare(b.metadata.title);
    if (by==='count')    return (b.metadata.count||0) - (a.metadata.count||0);
    if (by==='duration') return (b.metadata.duration||0) - (a.metadata.duration||0);
    // recent: 파일명 desc
    return b.key.localeCompare(a.key);
  });

  return out;
}

function renderCards(list, gridSel, emptySel){
  const grid = $(gridSel);
  grid.classList.remove('list','grid-3','grid-2');
  if (gridSel==='#recentsGrid') grid.classList.add('grid-2'); else grid.classList.add('grid-3');
  if (LAYOUT==='list') grid.classList.add('list');

  grid.innerHTML='';
  if (!list.length){ show(emptySel,true); return; } else { show(emptySel,false); }

  list.forEach(it=>{
    const { title='Untitled', tags=[], count=0, thumb=null, topics=[], level='', duration=0, subject='' } = it.metadata||{};
const isRW = (subject||'').toLowerCase()==='rw' || (tags||[]).includes('rw');
const isMath = (subject||'').toLowerCase()==='math' || (tags||[]).includes('math');
const phLabel = isRW ? 'RW' : (isMath ? 'Math' : 'Set');

card.innerHTML = `
  <div class="thumb">
    ${
      thumb
      ? `<img src="${thumb}" alt="">`
      : `<div class="ph ${isRW?'rw':(isMath?'math':'')}">${phLabel} preview</div>`
    }
  </div>
  <div class="body">
    <div class="title">${title}</div>
    <div class="sub">
      ${it.type.toUpperCase()} · <span class="muted">${it.key}</span>
      ${count?` · ${count} Qs`:''}
      ${duration?` · ${duration}m`:''}
    </div>
    <div class="tags">
      ${topics.map(t=>`<span class="tag">${t}</span>`).join(' ')}
      ${level?`<span class="tag">Level: ${level}</span>`:''}
    </div>
    <div class="foot"><button class="btn primary">Start</button></div>
  </div>
`;
// ... (카드 innerHTML 만든 직후)
const hasPaid = ENTS.includes('PAID_SETS');
const hasInternal = ENTS.includes('INTERNAL_SETS');
const isPaid = it.type === 'paid';
const isInternal = it.type === 'internal';
const locked = (isPaid && !hasPaid) || (isInternal && !hasInternal);

const startBtn = card.querySelector('.btn.primary');
if (locked) {
  startBtn.textContent = 'Locked 🔒';
  startBtn.classList.remove('primary');
  startBtn.onclick = ()=> openLockedModal(it.type);
  card.style.opacity = .85; // 살짝 흐리게
} else {
  startBtn.onclick = ()=>{
    location.href = `/practice.html?type=${encodeURIComponent(it.type)}&key=${encodeURIComponent(it.key)}`;
  };
}
    card.querySelector('.btn.primary').onclick = ()=>{
      // recents에는 정확한 tier 정보가 없을 수 있으므로 trial 기본값 추정
      let type = it.type==='recent' ? 'trial' : it.type;
      if (it.type==='recent'){
        // 태그 기반 보정
        if (tags.includes('paid')) type='paid';
        if (tags.includes('internal')) type='internal';
      }
      location.href = `/practice.html?type=${encodeURIComponent(type)}&key=${encodeURIComponent(it.key)}`;
    };

    grid.appendChild(card);
  });
}

function render(){
  const list = applyFilters(flattenCatalogByView());

  if (VIEW==='catalog'){
    renderCards(list, '#catalogGrid', '#catalogEmpty');
  } else if (VIEW==='owned'){
    renderCards(list, '#ownedGrid', '#ownedEmpty');
  } else if (VIEW==='recents'){
    renderCards(list, '#recentsGrid', '#recentsEmpty');
  }

  // Owned count
  if (VIEW!=='owned'){
    const ownedCount = (ENTS.includes('PAID_SETS')? (SETS.paid?.length||0):0) + (ENTS.includes('INTERNAL_SETS')? (SETS.internal?.length||0):0);
    $('#ownedCount').textContent = `Owned ${ownedCount}`;
  } else {
    $('#ownedCount').textContent = `Owned ${list.length}`;
  }
}

// 7) 초기화
(async function init(){
  // 로그인/토큰 체크
  try { await getIdTokenOrJwt(); } catch { return; }

  bindUI();

  // 사용자 정보(역할/권한) 조회
  try{
    const info = await apiGet('/api/health'); // { user:{role, entitlements}, ... }
    if (info?.user){
      ROLE = info.user.role || 'student';
      ENTS = info.user.entitlements || [];
      if (ROLE==='admin'){
        document.querySelector('.tab.admin').classList.remove('hidden');
        $('#roleBadge').classList.remove('hidden');
        $('#roleBadge').textContent='ADMIN';
      }
    }
  }catch{}

  // 카탈로그 적재
  const data = await apiGet('/api/sets'); // { trial, paid, internal } with metadata
  SETS = data || {trial:[],paid:[],internal:[]};

  // URL ?tab=trial|paid|internal 초기값 반영 → tierSelect
  const initTab = new URL(location.href).searchParams.get('tab');
  if (initTab && ['trial','paid','internal','all'].includes(initTab)) {
    tierSelect.value = initTab;
  }
  populateTopics();   
  render();

  // 관리자: 권한 부여 (claims 객체 방식 권장)
  $('#grantBtn').onclick = async ()=>{
    try{
      const email = $('#grantUser').value.trim();
      const ent = $('#grantEnt').value;
      if(!email) return alert('Enter user email.');
      const resp = await apiPost('/api/admin/grant', { email, claims: { [ent]: true } });
      alert('Granted:\n' + JSON.stringify(resp, null, 2));
    }catch(e){ alert('Failed: '+e.message); }
  };

})();

</script>

<!-- Locked Modal -->
<div id="lockedBack" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;border-radius:12px;max-width:460px;width:92%;padding:16px;border:1px solid #e5e7eb">
    <div style="font-weight:800;margin-bottom:8px">This set is locked</div>
    <div id="lockedMsg" class="muted" style="margin-bottom:12px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
      <a class="btn" href="/purchase.html">Buy access (demo)</a>
      <button class="btn" id="lockedClose">Close</button>
    </div>
  </div>
</div>
<script>
function openLockedModal(tier){
  const msg = document.getElementById('lockedMsg');
  msg.textContent = tier==='internal'
    ? 'Internal sets require instructor access.'
    : 'Paid sets require a purchase on your account.';
  document.getElementById('lockedBack').style.display='flex';
}
document.getElementById('lockedClose')?.addEventListener('click',()=>{
  document.getElementById('lockedBack').style.display='none';
});
</script>

</body>
</html>
