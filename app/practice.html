<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DSAT Practice â€” Classic UI</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script defer id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="./assets/style.css">

  <!-- ì»¤ë¸Œ í”„ë¦¬ì…‹: ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ë³´ë‹¤ ë¨¼ì € ë¡œë“œ -->
  <script src="./assets/curves.presets.js"></script>
  <!-- App modules (split from app.js) -->
  <script src="./assets/modules/mysets.js"></script>
  <script src="./assets/modules/utils.js"></script>
  <script src="./assets/modules/globals.js"></script>
  <script src="./assets/modules/curves.js"></script>
  <script src="./assets/modules/attempts.js"></script>
  <script src="./assets/modules/indexing.js"></script>
  <script src="./assets/modules/render.js"></script>
  <script src="./assets/modules/review.js"></script>
  <script src="./assets/review.enhance.js"></script>
  <script src="./assets/modules/csv.js"></script>
  <script src="./assets/modules/loader.js"></script>
</head>
<body>

  <!-- ===== TOP BAR ===== -->
  <div class="topbar">
    <div class="topbar-row">
      <div class="dir-zone" style="position:relative">
        <div class="crumb" id="crumb" aria-live="polite">Section â€” Module</div>
        <!-- â–¶ Directions ë²„íŠ¼ (íŒì˜¤ë²„ íŠ¸ë¦¬ê±°) -->
        <button class="hide-btn" id="dirToggle" type="button" aria-haspopup="dialog" aria-expanded="false">Directions â–¾</button>
        <span id="modeBadge" class="badge">Mode: Full</span>
        <!-- â–¶ ë ˆê±°ì‹œ: íŒ¨ë„ë¡œ ì£¼ì…ë˜ë©´ ìë™ ê°€ë¡œì±„ íŒì˜¤ë²„ë¡œ ì „í™˜ -->
        <div class="dir-panel" id="dirPanel" style="display:none"></div>
      </div>
      <div class="timer-wrap">
        <span class="timer" id="timer" aria-live="polite">35:00</span>
        <button class="hide-btn" id="hideBtn" type="button">Hide</button>
      </div>
      <div class="controls">
        <button class="icon-btn" type="button">ğŸ”¢ Calculator</button>
        <button class="icon-btn" type="button">ğŸ“„ Reference</button>
        <button class="icon-btn" type="button">â‹¯ More</button>
        <button class="icon-btn" type="button" onclick="location.href='./dashboard.html'">ğŸ“ˆ Dashboard</button>
      </div>
    </div>
    <div class="dash"></div>
  </div>

  <div class="wrap" id="appWrap">
    <!-- ë¡œë” (ë ˆê±°ì‹œ ìœ ì§€: URL íŒŒë¼ë¯¸í„° ì—†ì„ ë•Œë§Œ ì‚¬ìš©) -->
    <div class="loader" id="loaderRow">
      <input id="path" type="text" value="./questions.json" aria-label="Set URL"/>
      <button class="btn" id="loadBtn" type="button">Load set</button>
      <input id="file" type="file" accept=".json,application/json" style="margin-left:10px" aria-label="Load set from file"/>
    </div>
    <div id="loadError" class="alert" style="display:none" role="alert"></div>

    <!-- ë¬¸ì œ ì¹´ë“œ -->
    <div class="qcard" id="card" style="display:none">
      <div class="qhead">
        <div class="qnum" id="qnum">1</div>
        <button id="flagBtn" class="flag-btn" type="button">Mark for Review</button>
      </div>
      <div class="qtitle" id="qtitle"></div>
      <div id="qcontainer"></div>
    </div>

    <div id="scoreBox"></div>
  </div>

  <!-- ===== í•˜ë‹¨ ê³ ì • ë¦¬ë³¸ ===== -->
  <div class="ribbon" id="ribbon" style="display:none">
    <div class="r-left">
      <button type="button" class="btn" id="prevBtn" aria-label="Previous question">â† Prev</button>
    </div>
    <div class="r-center">
      <button class="btn ghost" id="navOpen" type="button" aria-haspopup="true" aria-expanded="false">1 / 22 â–¾</button>
    </div>
    <div class="r-right">
      <button type="button" class="btn" id="nextBtn" aria-label="Next question">Next â†’</button>
    </div>
  </div>

  <!-- ë„¤ë¹„ íŒì—… -->
  <div class="nav-popup" id="navPopup" role="dialog" aria-modal="false" aria-labelledby="navSection" style="display:none">
    <div style="font-weight:700; margin-bottom:8px">
      <span id="navSection">Section</span> Â· Module <span id="navMod">1</span>
    </div>
    <div class="nav-grid" id="navGrid"></div>
  </div>

  <!-- ===== ì œì¶œ í™•ì¸ ëª¨ë‹¬ ===== -->
  <div class="modal-back" id="confirmBack" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmModLabel">
      <div class="head">Submit now?</div>
      <div class="body">
        <div style="margin-bottom:8px">You are submitting <b id="confirmModLabel">Section Â· Module</b>.</div>
        <ul style="margin:0; padding-left:18px; color:var(--muted); font-size:14px">
          <li>After submission, answers for this module can no longer be changed.</li>
          <li>If this is Module 1 in a section, Module 2 in the same section will start automatically.</li>
          <li>After the final module (Math Module 2), a combined report and explanations will be shown.</li>
        </ul>
      </div>
      <div class="foot">
        <button class="btn" id="confirmCancel" type="button">Cancel</button>
        <button class="btn primary" id="confirmOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- ===== í•´ì„¤ íŒì—… ===== -->
  <div class="explain-back" id="explainBack" style="display:none">
    <div class="explain" role="dialog" aria-modal="true" aria-labelledby="explainClose">
      <button class="x" id="explainClose" type="button">Close</button>
      <div id="explainBody"></div>
    </div>
  </div>

  <!-- ë™ê¸°í™” ëª¨ë“ˆ(ë ˆê±°ì‹œ) -->
  <script>window.SYNC_API_BASE="http://localhost:4311";</script>
  <script src="./sync.js"></script>
  <!-- ì•± ìŠ¤í¬ë¦½íŠ¸ (ë ˆê±°ì‹œ ìœ ì§€) -->
  <script src="./assets/app.js"></script>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <!-- ë¡œì»¬ JWT í´ë°± -->
  <script src="/_auth.js"></script>

  <!-- ===== Directions Popover (2-A, ì›ë¬¸ ìœ ì§€) ===== -->
  <script>
  (function(){
    let __dirPopover = null;

    function closeDirectionsPopover(){
      if (__dirPopover) {
        __dirPopover.remove();
        __dirPopover = null;
        document.removeEventListener('mousedown', onOutside);
        window.removeEventListener('resize', onResize);
        window.removeEventListener('scroll', onScroll, true);
        document.removeEventListener('keydown', onEsc);
      }
      const btn = document.getElementById('dirToggle');
      if (btn) btn.setAttribute('aria-expanded', 'false');
    }

    function positionPopoverBelow(anchorEl, popEl, gap = 8){
      if (!anchorEl || !popEl) return;
      const rect = anchorEl.getBoundingClientRect();
      const top = rect.bottom + gap + window.scrollY;
      let left = rect.left + window.scrollX;
      const maxLeft = window.scrollX + document.documentElement.clientWidth - popEl.offsetWidth - 12;
      if (left > maxLeft) left = Math.max(12 + window.scrollX, maxLeft);
      popEl.style.top = top + 'px';
      popEl.style.left = left + 'px';

      const arrow = popEl.querySelector('.arrow');
      if (arrow) {
        const arrowLeft = Math.min(Math.max(24, rect.width/2), popEl.offsetWidth - 24);
        arrow.style.left = arrowLeft + 'px';
      }
    }

    function getDefaultDirectionsHTML(){
      return `
        <p>ì´ ì„¹ì…˜ì€ ì‹œê°„ ì œí•œì´ ìˆìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ ì°¨ë¡€ëŒ€ë¡œ í’€ë˜, ëª¨ë¥´ëŠ” ë¬¸ì œëŠ” í‘œì‹œ(Flag)í•˜ê³  ë„˜ì–´ê°€ì„¸ìš”.</p>
        <ul>
          <li>ë‹µì•ˆì„ ì„ íƒí•˜ë©´ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</li>
          <li>ë„¤ë¹„ê²Œì´í„°(Â· Â· Â·)ì—ì„œ ë¬¸ì œ ì´ë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
          <li>ì‹œê°„ ì¢…ë£Œ ì „ì´ë¼ë„ ì–¸ì œë“  ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
      `;
    }

    function openDirectionsPopover(anchorEl, htmlContent){
      closeDirectionsPopover();
      const bodyHTML = htmlContent || getDefaultDirectionsHTML();
      const html = `
        <div class="popover" id="directionsPopover" role="dialog" aria-modal="false" aria-labelledby="dirTitle" tabindex="-1">
          <div class="arrow"></div>
          <div class="head">
            <div class="title" id="dirTitle">Directions</div>
            <button class="x" type="button" id="dirCloseX" aria-label="Close directions">ë‹«ê¸°</button>
          </div>
          <div class="body" id="dirBody" tabindex="0">${bodyHTML}</div>
          <div class="foot">
            <button class="btn primary" id="dirOkBtn" type="button">í™•ì¸</button>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
      __dirPopover = document.getElementById('directionsPopover');

      // ìœ„ì¹˜
      positionPopoverBelow(anchorEl, __dirPopover, 8);

      // ìŠ¤í¬ë¡¤ ê·¸ë¦¼ì í† ê¸€
      const bodyEl = __dirPopover.querySelector('.body');
      const updateShadows = ()=>{
        if (!bodyEl) return;
        const top = bodyEl.scrollTop;
        const max = bodyEl.scrollHeight - bodyEl.clientHeight;
        __dirPopover.classList.toggle('show-top-shadow', top > 0);
        __dirPopover.classList.toggle('show-bottom-shadow', top < max - 1);
      };
      bodyEl.addEventListener('scroll', updateShadows, { passive:true });
      requestAnimationFrame(updateShadows);

      // ì ‘ê·¼ì„±: í¬ì»¤ìŠ¤ íŠ¸ë©
      const okBtn = document.getElementById('dirOkBtn');
      const closeBtn = document.getElementById('dirCloseX');
      const focusables = ()=> Array.from(__dirPopover.querySelectorAll(
        'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'
      )).filter(el=> !el.hasAttribute('disabled') && el.offsetParent !== null);
      const trap = (e)=>{
        if (e.key !== 'Tab') return;
        const els = focusables();
        if (!els.length) return;
        const first = els[0], last = els[els.length - 1];
        if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
        else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
      };
      __dirPopover.addEventListener('keydown', trap);

      // ë²„íŠ¼ ë™ì‘
      closeBtn.onclick = closeDirectionsPopover;
      okBtn.onclick = closeDirectionsPopover;

      // ë°”ê¹¥/ESC/ë¦¬ì‚¬ì´ì¦ˆ/ìŠ¤í¬ë¡¤ í•¸ë“¤ëŸ¬
      document.addEventListener('mousedown', onOutside);
      window.addEventListener('resize', onResize);
      window.addEventListener('scroll', onScroll, true);
      document.addEventListener('keydown', onEsc);

      // í† ê¸€ ìƒíƒœ
      if (anchorEl) anchorEl.setAttribute('aria-expanded', 'true');

      // ì´ˆê¸° í¬ì»¤ìŠ¤
      (okBtn || __dirPopover).focus();
    }

    // ì™¸ë¶€/ESC í•¸ë“¤ëŸ¬
    function onOutside(e){
      const btn = document.getElementById('dirToggle');
      if (__dirPopover && !__dirPopover.contains(e.target) && e.target !== btn) {
        closeDirectionsPopover();
      }
    }
    function onResize(){
      const btn = document.getElementById('dirToggle');
      if (__dirPopover && btn) positionPopoverBelow(btn, __dirPopover, 8);
    }
    function onScroll(){ onResize(); }
    function onEsc(e){ if (e.key === 'Escape') closeDirectionsPopover(); }

    // ë²„íŠ¼ í† ê¸€
    const btn = document.getElementById('dirToggle');
    if (btn) {
      btn.addEventListener('click', ()=>{
        if (__dirPopover) closeDirectionsPopover();
        else openDirectionsPopover(btn, document.getElementById('dirPanel')?.innerHTML || '');
      });
    }

    // ë ˆê±°ì‹œ í˜¸í™˜: ê¸°ì¡´ ì½”ë“œê°€ #dirPanelì— ë‚´ìš©ì„ ì£¼ì…/ë…¸ì¶œí•˜ë©´ ìë™ìœ¼ë¡œ íŒì˜¤ë²„ë¡œ ì „í™˜
    const panel = document.getElementById('dirPanel');
    if (panel) {
      const obs = new MutationObserver(()=>{
        const hasContent = panel.innerHTML && panel.innerHTML.trim().length > 0;
        const isShown = panel.style.display !== 'none' && panel.offsetParent !== null;
        if (hasContent || isShown) {
          panel.style.display = 'none'; // íŒ¨ë„ í‘œì‹œëŠ” ë§‰ê³ 
          if (btn) openDirectionsPopover(btn, panel.innerHTML); // íŒì˜¤ë²„ë¡œ ëŒ€ì²´
        }
      });
      obs.observe(panel, { attributes:true, childList:true, subtree:true, attributeFilter:['style','class'] });
    }

    // ì „ì—­ì—ì„œ ì‹œì‘ ì‹œì ì— í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ë…¸ì¶œ
    window.__openDirectionsFromStart = function(){
      const content = panel?.innerHTML || '';
      if (btn) openDirectionsPopover(btn, content);
    };
  })();
  </script>

  <!-- ====== ì–´ëŒ‘í„° & API ì—°ê²°(ì‹ ê·œ) ====== -->
  <!-- (ìˆìœ¼ë©´ ì‚¬ìš©) ì™¸ë¶€ ì–´ëŒ‘í„° íŒŒì¼ -->
  <script type="module">
  // ì™¸ë¶€ íŒŒì¼ì´ ì—†ëŠ” í™˜ê²½ë„ ê³ ë ¤í•˜ì—¬ ë™ì ìœ¼ë¡œ import, ì‹¤íŒ¨ ì‹œ ì¸ë¼ì¸ í´ë°± ì‚¬ìš©
  let Adapter = null;
  try {
    Adapter = await import('./assets/dsat/renderer.adapter.js');
  } catch {
    // í´ë°± ì–´ëŒ‘í„°(ìµœì†Œ êµ¬í˜„): window.startPractice/json ì„ ê·¸ëŒ€ë¡œ í˜¸ì¶œ
    Adapter = {
      attachAndRun: async (setJson, ctx) => {
        const entry = (typeof window.startPractice === 'function')
          ? window.startPractice
          : (typeof window.startPracticeEngine === 'function' ? window.startPracticeEngine : null);
        if (!entry) {
          const e = document.getElementById('loadError');
          e.style.display='block';
          e.classList.add('alert');
          e.textContent='Renderer entry not found (window.startPractice).';
          return;
        }
        // MathJax re-typeset í›…
        const typeset = async ()=> {
          try { if (window.MathJax?.typesetPromise) await window.MathJax.typesetPromise(); } catch {}
        };
        await entry(setJson, {
          assetURL: (rel) => {
            const prefix = ctx.tier==='paid' ? '/api/paid-asset/' :
                           ctx.tier==='internal' ? '/api/internal-asset/' : '/api/trial-asset/';
            return prefix + encodeURIComponent(rel);
          },
          onRendered: typeset,
          saveAttempt: async (a)=>{ try { await ctx.attempts.saveBulk([a]); } catch(e){} },
          saveAttemptsBulk: async (aa)=>{ try { await ctx.attempts.saveBulk(aa); } catch(e){} },
          listAttempts: async (since)=>{ try { return await ctx.attempts.list(since); } catch(e){ return []; } },
          user: ctx.user||null
        });
        await typeset();
      }
    };
  }

  // ===== ê³µí†µ ìœ í‹¸ =====
  function qsParam(name){ return new URL(location.href).searchParams.get(name); }
  function setModeBadgeFromSet(){
    const span = document.getElementById('modeBadge');
    if (!span) return;
    const only = qsParam('only'); // rw | math | (empty)
    span.textContent = 'Mode: ' + (only ? only.toUpperCase() : 'Full');
  }
  function show(el, on){ el.style.display = on ? '' : 'none'; }

  // ===== ì¸ì¦ & API =====
  async function getIdTokenOrJwt() {
    try {
      if (window.firebase?.auth) {
        const u = firebase.auth().currentUser || null;
        if (!u) throw new Error('no-firebase-user');
        return await u.getIdToken(true);
      }
    } catch {}
    const jwt = localStorage.getItem('jwt') || '';
    if (!jwt) {
      location.href = '/login.html';
      throw new Error('no-token');
    }
    return jwt;
  }
  async function apiGet(url){
    const token = await getIdTokenOrJwt();
    const r = await fetch(url, { headers:{ Authorization:'Bearer '+token }});
    if (r.status===401) { location.href='/login.html'; return null; }
    if (!r.ok) throw new Error(await r.text().catch(()=>String(r.status)));
    return r.json();
  }
  async function apiPost(url, body){
    const token = await getIdTokenOrJwt();
    const r = await fetch(url, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token },
      body: JSON.stringify(body||{})
    });
    if (!r.ok) throw new Error(await r.text().catch(()=>String(r.status)));
    return r.json();
  }

  // Attempts í´ë¼ì´ì–¸íŠ¸ (ì„œë²„ ë™ê¸°í™”)
  function AttemptsClient(user){
    const getUserId = ()=> user?.sub || user?.email || 'local-user';
    return {
      async list(sinceMs=null){
        const qs = sinceMs ? `?userId=${encodeURIComponent(getUserId())}&since=${Number(sinceMs)}`
                           : `?userId=${encodeURIComponent(getUserId())}`;
        const data = await apiGet('/api/attempts' + qs);
        return data?.attempts || [];
      },
      async saveBulk(attempts){
        if (!Array.isArray(attempts) || !attempts.length) return { savedIds:[] };
        const ok = attempts.every(a => a && a.id && a.baseId && a.kind && a.sections && a.ts);
        if (!ok) { console.warn('Invalid attempt schema:', attempts); return { savedIds:[] }; }
        return await apiPost('/api/attempts/bulk', { userId: getUserId(), attempts });
      }
    };
  }

  // ====== ì´ˆê¸°í™” ======
  (async function init(){
    // URL íŒŒë¼ë¯¸í„° íŒŒì‹±
    const tier = (qsParam('type') || '').toLowerCase(); // trial|paid|internal
    const key  = qsParam('key');                        // <set>.json
    const hasUrlSet = !!(tier && key);

    // ì‚¬ìš©ì ì •ë³´(ê¶Œí•œ/ì—­í• )
    let user = { role:'student', entitlements:[] };
    try {
      const health = await apiGet('/api/health'); // { user:{ role, entitlements, sub, email } }
      if (health?.user) user = health.user;
    } catch {}

    // ë ˆê±°ì‹œ ë¡œë” ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
    const loaderRow = document.getElementById('loaderRow');
    show(loaderRow, !hasUrlSet);

    // URLë¡œ ë“¤ì–´ì˜¨ ê²½ìš°: ì„œë²„ì—ì„œ ì„¸íŠ¸ ë¡œë“œ â†’ ì—”ì§„ ì‹¤í–‰
    if (hasUrlSet) {
      setModeBadgeFromSet();
      const errBox = document.getElementById('loadError');
      try {
        errBox.style.display='block';
        errBox.classList.remove('alert');
        errBox.textContent = `Loading set: ${tier} Â· ${key}`;
      } catch {}

      // === [ì¤‘ìš” íŒ¨ì¹˜] 403/404 êµ¬ë¶„ ë¡œë“œ ===
      let setJson = null;
      try {
        const token = await getIdTokenOrJwt();
        const r = await fetch(`/api/${tier}-set/${encodeURIComponent(key)}`, {
          headers:{ Authorization: 'Bearer ' + token }
        });

        if (r.status === 403) {
          // ê¶Œí•œ ì—†ìŒ â†’ êµ¬ë§¤/ê¶Œí•œ ì•ˆë‚´ ì¹´ë“œ
          const app = document.getElementById('appWrap');
          const card = document.createElement('div');
          card.className = 'card';
          card.style.marginTop = '12px';
          card.innerHTML = `
            <div style="font-weight:800;margin-bottom:6px">This set is locked</div>
            <div class="muted" style="margin-bottom:10px">
              ${tier==='internal'
                ? 'Internal sets require instructor approval.'
                : 'Paid sets require a valid purchase on your account.'}
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <a class="btn" href="/purchase.html">Buy access (demo)</a>
              <a class="btn" href="/catalog.html">Back to catalog</a>
            </div>
          `;
          errBox.style.display='none';
          app.appendChild(card);
          return;
        }
        if (r.status === 404) {
          // ì„¸íŠ¸ ì—†ìŒ â†’ ì•ˆë‚´
          errBox.style.display='block';
          errBox.classList.add('alert');
          errBox.innerHTML = `
            <div style="font-weight:700;margin-bottom:6px">Set not found</div>
            <div class="muted" style="margin-bottom:8px">The requested set does not exist or has been removed.</div>
            <div><a class="btn" href="/catalog.html">Back to catalog</a></div>
          `;
          return;
        }
        if (!r.ok) {
          throw new Error('HTTP_' + r.status);
        }
        setJson = await r.json();
      } catch (e) {
        // ê¸°íƒ€ ì˜¤ë¥˜
        errBox.style.display='block';
        errBox.classList.add('alert');
        errBox.textContent = 'Failed to load set. Please try again from the catalog.';
        return;
      }

      // Attempts ì¤€ë¹„
      const attempts = AttemptsClient(user);

      // ì—”ì§„ ì—°ê²°
      await Adapter.attachAndRun(setJson, {
        tier, key,
        http: { get: apiGet, post: apiPost },
        user,
        attempts
      });

      // Directions íŒì˜¤ë²„ ìë™ ì˜¤í”ˆ(í•„ìš” ì‹œ)
      if (typeof window.__openDirectionsFromStart === 'function') {
        setTimeout(()=> window.__openDirectionsFromStart(), 50);
      }

      // ë¡œë”© ë©”ì‹œì§€ ì œê±°
      try { errBox.style.display='none'; } catch {}
      return;
    }

    // ===== URL íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ë ˆê±°ì‹œ ë¡œë” ê·¸ëŒ€ë¡œ ì‚¬ìš© =====
    // ê¸°ì¡´ #loadBtn, #file ë™ì‘ì€ app/modules/loader.jsê°€ ì²˜ë¦¬.

  })();
  </script>
</body>
</html>
