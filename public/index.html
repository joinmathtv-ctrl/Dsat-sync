<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DSAT Practice — Classic UI</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script defer id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- 공통 스타일 -->
<link rel="stylesheet" href="./assets/style.css">

<!-- 커브 프리셋: 메인 스크립트보다 먼저 로드 -->
<script src="./assets/curves.presets.js"></script>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topbar-row">
    <div class="dir-zone" style="position:relative">
      <div class="crumb" id="crumb">Section — Module</div>
      <!-- ▶ Directions 버튼 (팝오버 트리거) -->
      <button class="hide-btn" id="dirToggle" type="button">Directions ▾</button>
      <!-- ▶ 레거시: 패널로 주입되면 자동 가로채 팝오버로 전환 -->
      <div class="dir-panel" id="dirPanel" style="display:none"></div>
    </div>
    <div class="timer-wrap">
      <span class="timer" id="timer">35:00</span>
      <button class="hide-btn" id="hideBtn">Hide</button>
    </div>
    <div class="controls">
      <button class="icon-btn">🔢 Calculator</button>
      <button class="icon-btn">📄 Reference</button>
      <button class="icon-btn">⋯ More</button>
      <button class="icon-btn" onclick="location.href='./dashboard.html'">📈 Dashboard</button>
    </div>
  </div>
  <div class="dash"></div>
</div>

<div class="wrap">
  <!-- 로더 -->
  <div class="loader" id="loaderRow">
    <input id="path" type="text" value="./questions.json" />
    <button class="btn" id="loadBtn">Load set</button>
    <input id="file" type="file" accept=".json,application/json" style="margin-left:10px"/>
  </div>
  <div id="loadError" class="alert" style="display:none"></div>

  <!-- 문제 카드 -->
  <div class="qcard" id="card" style="display:none">
    <div class="qhead">
      <div class="qnum" id="qnum">1</div>
      <button id="flagBtn" class="flag-btn">Mark for Review</button>
    </div>
    <div class="qtitle" id="qtitle"></div>
    <div id="qcontainer"></div>
  </div>

  <div id="scoreBox"></div>
</div>

<!-- ===== 하단 고정 리본 ===== -->
<div class="ribbon" id="ribbon" style="display:none">
  <div class="r-left">
    <button type="button" class="btn" id="prevBtn">← Prev</button>
  </div>
  <div class="r-center">
    <button class="btn ghost" id="navOpen">1 / 22 ▾</button>
  </div>
  <div class="r-right">
    <button type="button" class="btn" id="nextBtn">Next →</button>
  </div>
</div>

<!-- 네비 팝업 -->
<div class="nav-popup" id="navPopup">
  <div style="font-weight:700; margin-bottom:8px"><span id="navSection">Section</span> · Module <span id="navMod">1</span></div>
  <div class="nav-grid" id="navGrid"></div>
</div>

<!-- ===== 제출 확인 모달 ===== -->
<div class="modal-back" id="confirmBack">
  <div class="modal">
    <div class="head">Submit now?</div>
    <div class="body">
      <div style="margin-bottom:8px">You are submitting <b id="confirmModLabel">Section · Module</b>.</div>
      <ul style="margin:0; padding-left:18px; color:var(--muted); font-size:14px">
        <li>After submission, answers for this module can no longer be changed.</li>
        <li>If this is Module 1 in a section, Module 2 in the same section will start automatically.</li>
        <li>After the final module (Math Module 2), a combined report and explanations will be shown.</li>
      </ul>
    </div>
    <div class="foot">
      <button class="btn" id="confirmCancel">Cancel</button>
      <button class="btn primary" id="confirmOk">OK</button>
    </div>
  </div>
</div>

<!-- ===== 해설 팝업 ===== -->
<div class="explain-back" id="explainBack">
  <div class="explain">
    <button class="x" id="explainClose">Close</button>
    <div id="explainBody"></div>
  </div>
</div>

<!-- 분리 스크립트 -->
<script src="./assets/app.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<!-- 동기화 모듈 -->
<script src="./assets/sync.js"></script>

<!-- ===== Directions Popover (2-A) ===== -->
<script>
(function(){
  let __dirPopover = null;

  function closeDirectionsPopover(){
    if (__dirPopover) {
      __dirPopover.remove();
      __dirPopover = null;
      document.removeEventListener('mousedown', onOutside);
      window.removeEventListener('resize', onResize);
      window.removeEventListener('scroll', onScroll, true);
      document.removeEventListener('keydown', onEsc);
    }
  }

  function positionPopoverBelow(anchorEl, popEl, gap = 8){
    if (!anchorEl || !popEl) return;
    const rect = anchorEl.getBoundingClientRect();
    const top = rect.bottom + gap + window.scrollY;
    let left = rect.left + window.scrollX;
    const maxLeft = window.scrollX + document.documentElement.clientWidth - popEl.offsetWidth - 12;
    if (left > maxLeft) left = Math.max(12 + window.scrollX, maxLeft);
    popEl.style.top = top + 'px';
    popEl.style.left = left + 'px';

    const arrow = popEl.querySelector('.arrow');
    if (arrow) {
      const arrowLeft = Math.min(Math.max(24, rect.width/2), popEl.offsetWidth - 24);
      arrow.style.left = arrowLeft + 'px';
    }
  }

  function getDefaultDirectionsHTML(){
    return `
      <p>이 섹션은 시간 제한이 있습니다. 문제를 차례대로 풀되, 모르는 문제는 표시(Flag)하고 넘어가세요.</p>
      <ul>
        <li>답안을 선택하면 자동 저장됩니다.</li>
        <li>네비게이터(· · ·)에서 문제 이동이 가능합니다.</li>
        <li>시간 종료 전이라도 언제든 제출할 수 있습니다.</li>
      </ul>
    `;
  }

   function openDirectionsPopover(anchorEl, htmlContent){
    closeDirectionsPopover();
    const bodyHTML = htmlContent || (window.CURRENT_SET && window.CURRENT_SET.directions) || getDefaultDirectionsHTML();
    const html = `
      <div class="popover" id="directionsPopover" role="dialog" aria-modal="false" aria-labelledby="dirTitle" tabindex="-1">
        <div class="arrow"></div>
        <div class="head">
          <div class="title" id="dirTitle">Directions</div>
          <button class="x" type="button" id="dirCloseX" aria-label="Close directions">닫기</button>
        </div>
        <div class="body" id="dirBody" tabindex="0">${bodyHTML}</div>
        <div class="foot">
          <button class="btn primary" id="dirOkBtn" type="button">확인</button>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
    __dirPopover = document.getElementById('directionsPopover');

    // 위치
    positionPopoverBelow(anchorEl, __dirPopover, 8);

    // 스크롤 그림자 토글
    const bodyEl = __dirPopover.querySelector('.body');
    const updateShadows = ()=>{
      if (!bodyEl) return;
      const top = bodyEl.scrollTop;
      const max = bodyEl.scrollHeight - bodyEl.clientHeight;
      __dirPopover.classList.toggle('show-top-shadow', top > 0);
      __dirPopover.classList.toggle('show-bottom-shadow', top < max - 1);
    };
    bodyEl.addEventListener('scroll', updateShadows, { passive:true });
    // 초기에 한 번 계산
    requestAnimationFrame(updateShadows);

    // 접근성: 포커스 트랩 & 초기 포커스
    const okBtn = document.getElementById('dirOkBtn');
    const closeBtn = document.getElementById('dirCloseX');
    const focusables = ()=> Array.from(__dirPopover.querySelectorAll(
      'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'
    )).filter(el=> !el.hasAttribute('disabled') && el.offsetParent !== null);
    const trap = (e)=>{
      if (e.key !== 'Tab') return;
      const els = focusables();
      if (!els.length) return;
      const first = els[0], last = els[els.length - 1];
      if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    };
    __dirPopover.addEventListener('keydown', trap);

    // 버튼 동작
    closeBtn.onclick = closeDirectionsPopover;
    okBtn.onclick = closeDirectionsPopover;

    // 바깥/ESC/리사이즈/스크롤 핸들러
    document.addEventListener('mousedown', onOutside);
    window.addEventListener('resize', onResize);
    window.addEventListener('scroll', onScroll, true);
    document.addEventListener('keydown', onEsc);

    // 초기 포커스: 본문 -> OK 버튼 순
    (okBtn || __dirPopover).focus();
  }

  // 외부/ESC 핸들러 (클로저에 필요하므로 함수 선언부는 아래)
  function onOutside(e){
    const btn = document.getElementById('dirToggle');
    if (__dirPopover && !__dirPopover.contains(e.target) && e.target !== btn) {
      closeDirectionsPopover();
    }
  }
  function onResize(){ 
    const btn = document.getElementById('dirToggle');
    if (__dirPopover && btn) positionPopoverBelow(btn, __dirPopover, 8);
  }
  function onScroll(){ onResize(); }
  function onEsc(e){ if (e.key === 'Escape') closeDirectionsPopover(); }

  // 버튼 토글
  const btn = document.getElementById('dirToggle');
  if (btn) {
    btn.addEventListener('click', ()=>{
      if (__dirPopover) closeDirectionsPopover();
      else openDirectionsPopover(btn, document.getElementById('dirPanel')?.innerHTML || '');
    });
  }

  // 레거시 호환: 기존 코드가 #dirPanel에 내용을 주입/노출하면 자동으로 팝오버로 전환
  const panel = document.getElementById('dirPanel');
  if (panel) {
    const obs = new MutationObserver(()=>{
      const hasContent = panel.innerHTML && panel.innerHTML.trim().length > 0;
      const isShown = panel.style.display !== 'none' && panel.offsetParent !== null;
      if (hasContent || isShown) {
        panel.style.display = 'none'; // 패널 표시는 막고
        if (btn) openDirectionsPopover(btn, panel.innerHTML); // 팝오버로 대체
      }
    });
    obs.observe(panel, { attributes:true, childList:true, subtree:true, attributeFilter:['style','class'] });
  }

  // 전역에서 시작 시점에 호출할 수 있도록 노출
  window.__openDirectionsFromStart = function(){
    const content = panel?.innerHTML || '';
    if (btn) openDirectionsPopover(btn, content);
  };
})();
</script>
</body>
</html>
