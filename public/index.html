<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DSAT Practice â€” Classic UI</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script defer id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
<link rel="stylesheet" href="./assets/style.css">

<!-- ì»¤ë¸Œ í”„ë¦¬ì…‹: ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ë³´ë‹¤ ë¨¼ì € ë¡œë“œ -->
<script src="./assets/curves.presets.js"></script>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topbar-row">
    <div class="dir-zone" style="position:relative">
      <div class="crumb" id="crumb">Section â€” Module</div>
      <!-- â–¶ Directions ë²„íŠ¼ (íŒì˜¤ë²„ íŠ¸ë¦¬ê±°) -->
      <button class="hide-btn" id="dirToggle" type="button">Directions â–¾</button>
      <!-- â–¶ ë ˆê±°ì‹œ: íŒ¨ë„ë¡œ ì£¼ì…ë˜ë©´ ìë™ ê°€ë¡œì±„ íŒì˜¤ë²„ë¡œ ì „í™˜ -->
      <div class="dir-panel" id="dirPanel" style="display:none"></div>
    </div>
    <div class="timer-wrap">
      <span class="timer" id="timer">35:00</span>
      <button class="hide-btn" id="hideBtn">Hide</button>
    </div>
    <div class="controls">
      <button class="icon-btn">ğŸ”¢ Calculator</button>
      <button class="icon-btn">ğŸ“„ Reference</button>
      <button class="icon-btn">â‹¯ More</button>
      <button class="icon-btn" onclick="location.href='./dashboard.html'">ğŸ“ˆ Dashboard</button>
    </div>
  </div>
  <div class="dash"></div>
</div>

<div class="wrap">
  <!-- ë¡œë” -->
  <div class="loader" id="loaderRow">
    <input id="path" type="text" value="./questions.json" />
    <button class="btn" id="loadBtn">Load set</button>
    <input id="file" type="file" accept=".json,application/json" style="margin-left:10px"/>
  </div>
  <div id="loadError" class="alert" style="display:none"></div>

  <!-- ë¬¸ì œ ì¹´ë“œ -->
  <div class="qcard" id="card" style="display:none">
    <div class="qhead">
      <div class="qnum" id="qnum">1</div>
      <button id="flagBtn" class="flag-btn">Mark for Review</button>
    </div>
    <div class="qtitle" id="qtitle"></div>
    <div id="qcontainer"></div>
  </div>

  <div id="scoreBox"></div>
</div>

<!-- ===== í•˜ë‹¨ ê³ ì • ë¦¬ë³¸ ===== -->
<div class="ribbon" id="ribbon" style="display:none">
  <div class="r-left">
    <button type="button" class="btn" id="prevBtn">â† Prev</button>
  </div>
  <div class="r-center">
    <button class="btn ghost" id="navOpen">1 / 22 â–¾</button>
  </div>
  <div class="r-right">
    <button type="button" class="btn" id="nextBtn">Next â†’</button>
  </div>
</div>

<!-- ë„¤ë¹„ íŒì—… -->
<div class="nav-popup" id="navPopup">
  <div style="font-weight:700; margin-bottom:8px"><span id="navSection">Section</span> Â· Module <span id="navMod">1</span></div>
  <div class="nav-grid" id="navGrid"></div>
</div>

<!-- ===== ì œì¶œ í™•ì¸ ëª¨ë‹¬ ===== -->
<div class="modal-back" id="confirmBack">
  <div class="modal">
    <div class="head">Submit now?</div>
    <div class="body">
      <div style="margin-bottom:8px">You are submitting <b id="confirmModLabel">Section Â· Module</b>.</div>
      <ul style="margin:0; padding-left:18px; color:var(--muted); font-size:14px">
        <li>After submission, answers for this module can no longer be changed.</li>
        <li>If this is Module 1 in a section, Module 2 in the same section will start automatically.</li>
        <li>After the final module (Math Module 2), a combined report and explanations will be shown.</li>
      </ul>
    </div>
    <div class="foot">
      <button class="btn" id="confirmCancel">Cancel</button>
      <button class="btn primary" id="confirmOk">OK</button>
    </div>
  </div>
</div>

<!-- ===== í•´ì„¤ íŒì—… ===== -->
<div class="explain-back" id="explainBack">
  <div class="explain">
    <button class="x" id="explainClose">Close</button>
    <div id="explainBody"></div>
  </div>
</div>

<!-- ë¶„ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="./assets/app.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<!-- ë™ê¸°í™” ëª¨ë“ˆ -->
<script src="./assets/sync.js"></script>

<!-- ===== Directions Popover (2-A) ===== -->
<script>
(function(){
  let __dirPopover = null;

  function closeDirectionsPopover(){
    if (__dirPopover) {
      __dirPopover.remove();
      __dirPopover = null;
      document.removeEventListener('mousedown', onOutside);
      window.removeEventListener('resize', onResize);
      window.removeEventListener('scroll', onScroll, true);
      document.removeEventListener('keydown', onEsc);
    }
  }

  function positionPopoverBelow(anchorEl, popEl, gap = 8){
    if (!anchorEl || !popEl) return;
    const rect = anchorEl.getBoundingClientRect();
    const top = rect.bottom + gap + window.scrollY;
    let left = rect.left + window.scrollX;
    const maxLeft = window.scrollX + document.documentElement.clientWidth - popEl.offsetWidth - 12;
    if (left > maxLeft) left = Math.max(12 + window.scrollX, maxLeft);
    popEl.style.top = top + 'px';
    popEl.style.left = left + 'px';

    const arrow = popEl.querySelector('.arrow');
    if (arrow) {
      const arrowLeft = Math.min(Math.max(24, rect.width/2), popEl.offsetWidth - 24);
      arrow.style.left = arrowLeft + 'px';
    }
  }

  function getDefaultDirectionsHTML(){
    return `
      <p>ì´ ì„¹ì…˜ì€ ì‹œê°„ ì œí•œì´ ìˆìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ ì°¨ë¡€ëŒ€ë¡œ í’€ë˜, ëª¨ë¥´ëŠ” ë¬¸ì œëŠ” í‘œì‹œ(Flag)í•˜ê³  ë„˜ì–´ê°€ì„¸ìš”.</p>
      <ul>
        <li>ë‹µì•ˆì„ ì„ íƒí•˜ë©´ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</li>
        <li>ë„¤ë¹„ê²Œì´í„°(Â· Â· Â·)ì—ì„œ ë¬¸ì œ ì´ë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        <li>ì‹œê°„ ì¢…ë£Œ ì „ì´ë¼ë„ ì–¸ì œë“  ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      </ul>
    `;
  }

   function openDirectionsPopover(anchorEl, htmlContent){
    closeDirectionsPopover();
    const bodyHTML = htmlContent || (window.CURRENT_SET && window.CURRENT_SET.directions) || getDefaultDirectionsHTML();
    const html = `
      <div class="popover" id="directionsPopover" role="dialog" aria-modal="false" aria-labelledby="dirTitle" tabindex="-1">
        <div class="arrow"></div>
        <div class="head">
          <div class="title" id="dirTitle">Directions</div>
          <button class="x" type="button" id="dirCloseX" aria-label="Close directions">ë‹«ê¸°</button>
        </div>
        <div class="body" id="dirBody" tabindex="0">${bodyHTML}</div>
        <div class="foot">
          <button class="btn primary" id="dirOkBtn" type="button">í™•ì¸</button>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
    __dirPopover = document.getElementById('directionsPopover');

    // ìœ„ì¹˜
    positionPopoverBelow(anchorEl, __dirPopover, 8);

    // ìŠ¤í¬ë¡¤ ê·¸ë¦¼ì í† ê¸€
    const bodyEl = __dirPopover.querySelector('.body');
    const updateShadows = ()=>{
      if (!bodyEl) return;
      const top = bodyEl.scrollTop;
      const max = bodyEl.scrollHeight - bodyEl.clientHeight;
      __dirPopover.classList.toggle('show-top-shadow', top > 0);
      __dirPopover.classList.toggle('show-bottom-shadow', top < max - 1);
    };
    bodyEl.addEventListener('scroll', updateShadows, { passive:true });
    // ì´ˆê¸°ì— í•œ ë²ˆ ê³„ì‚°
    requestAnimationFrame(updateShadows);

    // ì ‘ê·¼ì„±: í¬ì»¤ìŠ¤ íŠ¸ë© & ì´ˆê¸° í¬ì»¤ìŠ¤
    const okBtn = document.getElementById('dirOkBtn');
    const closeBtn = document.getElementById('dirCloseX');
    const focusables = ()=> Array.from(__dirPopover.querySelectorAll(
      'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'
    )).filter(el=> !el.hasAttribute('disabled') && el.offsetParent !== null);
    const trap = (e)=>{
      if (e.key !== 'Tab') return;
      const els = focusables();
      if (!els.length) return;
      const first = els[0], last = els[els.length - 1];
      if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    };
    __dirPopover.addEventListener('keydown', trap);

    // ë²„íŠ¼ ë™ì‘
    closeBtn.onclick = closeDirectionsPopover;
    okBtn.onclick = closeDirectionsPopover;

    // ë°”ê¹¥/ESC/ë¦¬ì‚¬ì´ì¦ˆ/ìŠ¤í¬ë¡¤ í•¸ë“¤ëŸ¬
    document.addEventListener('mousedown', onOutside);
    window.addEventListener('resize', onResize);
    window.addEventListener('scroll', onScroll, true);
    document.addEventListener('keydown', onEsc);

    // ì´ˆê¸° í¬ì»¤ìŠ¤: ë³¸ë¬¸ -> OK ë²„íŠ¼ ìˆœ
    (okBtn || __dirPopover).focus();
  }

  // ì™¸ë¶€/ESC í•¸ë“¤ëŸ¬ (í´ë¡œì €ì— í•„ìš”í•˜ë¯€ë¡œ í•¨ìˆ˜ ì„ ì–¸ë¶€ëŠ” ì•„ë˜)
  function onOutside(e){
    const btn = document.getElementById('dirToggle');
    if (__dirPopover && !__dirPopover.contains(e.target) && e.target !== btn) {
      closeDirectionsPopover();
    }
  }
  function onResize(){ 
    const btn = document.getElementById('dirToggle');
    if (__dirPopover && btn) positionPopoverBelow(btn, __dirPopover, 8);
  }
  function onScroll(){ onResize(); }
  function onEsc(e){ if (e.key === 'Escape') closeDirectionsPopover(); }

  // ë²„íŠ¼ í† ê¸€
  const btn = document.getElementById('dirToggle');
  if (btn) {
    btn.addEventListener('click', ()=>{
      if (__dirPopover) closeDirectionsPopover();
      else openDirectionsPopover(btn, document.getElementById('dirPanel')?.innerHTML || '');
    });
  }

  // ë ˆê±°ì‹œ í˜¸í™˜: ê¸°ì¡´ ì½”ë“œê°€ #dirPanelì— ë‚´ìš©ì„ ì£¼ì…/ë…¸ì¶œí•˜ë©´ ìë™ìœ¼ë¡œ íŒì˜¤ë²„ë¡œ ì „í™˜
  const panel = document.getElementById('dirPanel');
  if (panel) {
    const obs = new MutationObserver(()=>{
      const hasContent = panel.innerHTML && panel.innerHTML.trim().length > 0;
      const isShown = panel.style.display !== 'none' && panel.offsetParent !== null;
      if (hasContent || isShown) {
        panel.style.display = 'none'; // íŒ¨ë„ í‘œì‹œëŠ” ë§‰ê³ 
        if (btn) openDirectionsPopover(btn, panel.innerHTML); // íŒì˜¤ë²„ë¡œ ëŒ€ì²´
      }
    });
    obs.observe(panel, { attributes:true, childList:true, subtree:true, attributeFilter:['style','class'] });
  }

  // ì „ì—­ì—ì„œ ì‹œì‘ ì‹œì ì— í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ë…¸ì¶œ
  window.__openDirectionsFromStart = function(){
    const content = panel?.innerHTML || '';
    if (btn) openDirectionsPopover(btn, content);
  };
})();
</script>
</body>
</html>
